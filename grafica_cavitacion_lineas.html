<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gráfico de Cavitación por Tubería</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    canvas {
      width: 100% !important;
      height: 500px !important;
    }
    .filtros {
      margin-bottom: 20px;
    }
    select {
      padding: 5px;
    }
  </style>
</head>
<body>
  <h2>Cavitación por Tubería: Presión vs. % de Sólidos</h2>

  <div class="filtros">
    <label for="filtroPresion">Tipo de Presión:</label>
    <select id="filtroPresion">
      <option value="min">Mínima (entre In y Out)</option>
      <option value="PStaticIn">P Static In</option>
      <option value="PStaticOut">P Static Out</option>
    </select>
  </div>

  <canvas id="graficoCavitacion"></canvas>

  <script>
    const datos = JSON.parse(localStorage.getItem("resumenDatos")) || [];

    const tuberias = [...new Set(datos.map(d => d.Tuberia))].sort();
    const filtroPresion = document.getElementById("filtroPresion");

    const colores = [
      "#e6194b", "#3cb44b", "#ffe119", "#4363d8", "#f58231", "#911eb4",
      "#46f0f0", "#f032e6", "#bcf60c", "#fabebe", "#008080", "#e6beff",
      "#9a6324", "#fffac8", "#800000", "#aaffc3", "#808000", "#ffd8b1"
    ];

    let chart;

    function actualizarGrafico() {
      const tipoPresion = filtroPresion.value;

      const datasets = tuberias.map((tub, i) => {
        const puntos = datos
          .filter(d => d.Tuberia === tub)
          .map(d => {
            let y;
            if (tipoPresion === "min") {
              y = Math.min(d.PStaticIn ?? Infinity, d.PStaticOut ?? Infinity);
            } else {
              y = d[tipoPresion] ?? null;
            }
            return { x: d.SS, y };
          })
          .filter(p => p.y !== null);

        return {
          label: tub,
          data: puntos.sort((a, b) => a.x - b.x),
          borderColor: colores[i % colores.length],
          fill: false,
          tension: 0.2
        };
      });

      datasets.push({
        label: "Presión de vapor (0.0234 bar)",
        data: [
          { x: Math.min(...datos.map(d => d.SS)), y: 0.0234 },
          { x: Math.max(...datos.map(d => d.SS)), y: 0.0234 }
        ],
        borderColor: "red",
        borderDash: [5, 5],
        pointRadius: 0,
        fill: false,
        tension: 0,
      });

      const ctx = document.getElementById("graficoCavitacion").getContext("2d");
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: "line",
        data: { datasets },
        options: {
          responsive: true,
          plugins: {
            legend: { position: "top" },
          },
          scales: {
            x: {
              type: "linear",
              title: { display: true, text: "% de Sólidos (SS)" }
            },
            y: {
              title: { display: true, text: "Presión (bar)" },
              min: 0
            }
          }
        }
      });
    }

    filtroPresion.addEventListener("change", actualizarGrafico);
    actualizarGrafico();
  </script>
</body>
</html>
