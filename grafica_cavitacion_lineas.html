<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Gráfico de Cavitación por Tubería</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.0"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    canvas { max-width: 100%; height: auto; }
    select, button { margin: 5px; padding: 5px; }
  </style>
</head>
<body>
  <h2>Gráfico de Cavitación (%SS vs Presión Estática)</h2>

  <label for="tipoPresion">Tipo de presión:</label>
  <select id="tipoPresion">
    <option value="0">P Static In</option>
    <option value="1">P Static Out</option>
  </select>

  <label for="tuberiasSelect">Filtrar tuberías:</label>
  <select id="tuberiasSelect" multiple size="5" style="width:200px;"></select>

  <div>
    <button onclick="chart.zoom(1.2)">Zoom In</button>
    <button onclick="chart.zoom(0.8)">Zoom Out</button>
    <button onclick="chart.resetZoom()">Reset Zoom</button>
    <button onclick="guardarGrafico()">Guardar como JPG</button>
  </div>

  <canvas id="graficoCavitacion"></canvas>

  <script>
    const datos = JSON.parse(localStorage.getItem('resumenDatos'));
    const tuberiasUnicas = [...new Set(datos.map(d => d[0]))];
    const tuberiasSelect = document.getElementById("tuberiasSelect");
    const tipoPresionSelect = document.getElementById("tipoPresion");

    tuberiasUnicas.forEach(t => {
      const option = document.createElement("option");
      option.value = t;
      option.textContent = t;
      option.selected = true;
      tuberiasSelect.appendChild(option);
    });

    const colores = [
      'red', 'blue', 'green', 'orange', 'purple', 'brown',
      'cyan', 'magenta', 'lime', 'teal', 'indigo', 'gold'
    ];

    let chart;

    function generarGrafico() {
      const tipoPresion = parseInt(tipoPresionSelect.value);
      const tuberiasSeleccionadas = Array.from(tuberiasSelect.selectedOptions).map(opt => opt.value);

      const datasets = tuberiasSeleccionadas.map((tuberia, index) => {
        const puntos = datos
          .filter(d => d[0] === tuberia)
          .map(d => ({
            x: parseFloat(d[8]),        // %SS
            y: parseFloat(d[1 + tipoPresion])  // P Static In = d[1], Out = d[2]
          }))
          .sort((a, b) => a.x - b.x);

        return {
          label: tuberia,
          data: puntos,
          borderColor: colores[index % colores.length],
          backgroundColor: colores[index % colores.length],
          tension: 0.3,
          fill: false
        };
      });

      if (chart) chart.destroy();

      const ctx = document.getElementById("graficoCavitacion").getContext("2d");
      chart = new Chart(ctx, {
        type: "line",
        data: { datasets },
        options: {
          responsive: true,
          interaction: {
            mode: "nearest",
            intersect: false
          },
          plugins: {
            legend: { display: true },
            zoom: {
              pan: { enabled: true, mode: "xy" },
              zoom: {
                wheel: { enabled: true },
                pinch: { enabled: true },
                mode: "xy"
              }
            }
          },
          scales: {
            x: {
              title: { display: true, text: "% Sólidos" },
              beginAtZero: true
            },
            y: {
              title: { display: true, text: "Presión Estática (bar)" }
            }
          }
        }
      });
    }

    function guardarGrafico() {
      const link = document.createElement("a");
      link.download = "grafico_cavitacion.jpg";
      link.href = chart.toBase64Image("image/jpeg", 1.0);
      link.click();
    }

    tipoPresionSelect.addEventListener("change", generarGrafico);
    tuberiasSelect.addEventListener("change", generarGrafico);

    generarGrafico();
  </script>
</body>
</html>

