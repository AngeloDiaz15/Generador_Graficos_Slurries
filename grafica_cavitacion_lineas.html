<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gráfico de Cavitación</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    canvas {
      max-width: 100%;
    }
    select {
      margin: 10px;
    }
  </style>
</head>
<body>
  <h2>Gráfico de Cavitación (Presión Estática)</h2>

  <label for="tipoPresion">Tipo de Presión:</label>
  <select id="tipoPresion">
    <option value="1">P Static In</option>
    <option value="2">P Static Out</option>
  </select>

  <label for="filtroTuberia">Tubería:</label>
  <select id="filtroTuberia">
    <option value="Todas">Todas</option>
  </select>

  <canvas id="graficoCavitacion"></canvas>

  <script>
    const datos = JSON.parse(localStorage.getItem("resumenDatos")) || [];

    const tipoPresionSelect = document.getElementById("tipoPresion");
    const filtroTuberiaSelect = document.getElementById("filtroTuberia");
    const ctx = document.getElementById("graficoCavitacion").getContext("2d");

    // Extraer lista de tuberías únicas
    const tuberias = [...new Set(datos.map(d => d[0]))].sort();
    tuberias.forEach(t => {
      const opt = document.createElement("option");
      opt.value = t;
      opt.textContent = t;
      filtroTuberiaSelect.appendChild(opt);
    });

    let chart;

    function actualizarGrafico() {
      const tipoPresion = parseInt(tipoPresionSelect.value); // 1 o 2
      const tuberiaSeleccionada = filtroTuberiaSelect.value;

      let datosFiltrados = datos;

      if (tuberiaSeleccionada !== "Todas") {
        datosFiltrados = datos.filter(d => d[0] === tuberiaSeleccionada);
      }

      const datosPorTuberia = {};

      datosFiltrados.forEach(d => {
        const tuberia = d[0];
        const SS = parseFloat(d[8]);
        const presion = parseFloat(d[tipoPresion]);

        if (!datosPorTuberia[tuberia]) datosPorTuberia[tuberia] = [];
        datosPorTuberia[tuberia].push({ x: SS , y: presion });
      });

      const datasets = Object.entries(datosPorTuberia).map(([nombre, puntos]) => ({
        label: nombre,
        data: puntos.sort((a, b) => a.x - b.x),
        borderColor: getColor(nombre),
        tension: 0.2,
        fill: false
      }));

      if (chart) chart.destroy();

      chart = new Chart(ctx, {
        type: "line",
        data: {
          datasets
        },
        options: {
          responsive: true,
          scales: {
            x: {
              title: {
                display: true,
                text: "% Sólidos"
              }
            },
            y: {
              title: {
                display: true,
                text: "Presión (bar)"
              },
              beginAtZero: false
            }
          },
          plugins: {
            legend: {
              display: true
            },
            tooltip: {
              callbacks: {
                label: context => `Tubería ${context.dataset.label}: ${context.parsed.y.toFixed(2)} bar`
              }
            }
          }
        }
      });
    }

    function getColor(nombre) {
      const colores = [
        "#FF6384", "#36A2EB", "#FFCE56", "#4BC0C0",
        "#9966FF", "#FF9F40", "#8AFF33", "#33FFD1",
        "#FF33EC", "#3385FF", "#FF6633", "#85FF33"
      ];
      const i = [...tuberias].indexOf(nombre) % colores.length;
      return colores[i];
    }

    tipoPresionSelect.addEventListener("change", actualizarGrafico);
    filtroTuberiaSelect.addEventListener("change", actualizarGrafico);

    actualizarGrafico();
  </script>
</body>
</html>

