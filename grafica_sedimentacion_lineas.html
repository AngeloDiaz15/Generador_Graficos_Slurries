<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Comportamiento de Ratio de Sedimentación por Tubería</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    canvas {
      max-width: 100%;
      height: 500px;
    }
    select {
      margin-bottom: 15px;
      padding: 5px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h2>Gráfico de Vm/Vsm vs % de Sólidos</h2>
  <label for="filtroTuberias">Filtrar por tubería:</label>
  <select id="filtroTuberias" multiple size="6" style="width: 250px;"></select>
  <br><br>
  <canvas id="graficoLineas"></canvas>

  <script>
    // === Obtener datos del localStorage ===
    const datos = JSON.parse(localStorage.getItem('resumenDatosGlobal')) || [];

    // === Extraer tuberías únicas y %SS ordenados ===
    const tuberias = [...new Set(datos.map(d => d.Tuberia))].sort();
    const porcentajes = [...new Set(datos.map(d => d.SS))].sort((a, b) => a - b);

    // === Paleta de solo 8 colores (Chart.js reutiliza si hay más) ===
    const coloresBase = [
      '#1f77b4', '#ff7f0e', '#2ca02c',
      '#d62728', '#9467bd', '#8c564b',
      '#e377c2', '#7f7f7f'
    ];

    // === Crear <select> para filtrar tuberías ===
    const selectFiltro = document.getElementById('filtroTuberias');
    tuberias.forEach(tub => {
      const opt = document.createElement('option');
      opt.value = tub;
      opt.text = tub;
      opt.selected = true;
      selectFiltro.appendChild(opt);
    });

    // === Función para construir datasets según selección ===
    function construirDatasets(tuberiasSeleccionadas) {
      return tuberiasSeleccionadas.map((tuberia, i) => {
        return {
          label: tuberia,
          data: porcentajes.map(ss => {
            const punto = datos.find(d => d.Tuberia === tuberia && d.SS === ss);
            return punto ? punto.Vm_Vsm : null;
          }),
          borderColor: coloresBase[i % coloresBase.length],
          backgroundColor: coloresBase[i % coloresBase.length],
          borderWidth: 2,
          fill: false
        };
      });
    }

    // === Crear gráfico inicial ===
    const ctx = document.getElementById('graficoLineas').getContext('2d');
    let grafico = new Chart(ctx, {
      type: 'line',
      data: {
        labels: porcentajes,
        datasets: construirDatasets(tuberias)
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: 'Relación Vm/Vsm por Tubería vs % de Sólidos'
          },
          legend: {
            display: true,
            position: 'bottom'
          }
        },
        scales: {
          x: {
            title: {
              display: true,
              text: '% de Sólidos'
            }
          },
          y: {
            title: {
              display: true,
              text: 'Vm/Vsm'
            },
            min: 0,
            max: 3
          }
        }
      }
    });

    // === Actualizar gráfico al cambiar selección ===
    selectFiltro.addEventListener('change', () => {
      const seleccionadas = Array.from(selectFiltro.selectedOptions).map(opt => opt.value);
      grafico.data.datasets = construirDatasets(seleccionadas);
      grafico.update();
    });
  </script>
</body>
</html>
