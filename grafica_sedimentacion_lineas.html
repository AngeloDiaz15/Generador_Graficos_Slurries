<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gráfico de Sedimentación</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    canvas {
      max-width: 1000px;
      margin: 20px auto;
      display: block;
    }
    .filtro-tuberias {
      max-width: 1000px;
      margin: 10px auto;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }
    label {
      font-family: sans-serif;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h2 style="text-align:center;">Gráfico de sedimentación (Vm/Vsm vs %SS)</h2>
  <div class="filtro-tuberias" id="filtroTuberias"></div>
  <canvas id="graficoSedimentacion"></canvas>

  <script>
    const resumen = JSON.parse(localStorage.getItem("resumenDatos") || "[]");

    if (!resumen.length) {
      alert("No hay datos en localStorage.");
    } else {
      // Organiza los datos por tubería
      const datosPorTuberia = {};

      resumen.forEach(item => {
        const tuberia = item[0];
        const SS = parseFloat(item[8]);
        const VmVsm = parseFloat(item[5]);

        if (!datosPorTuberia[tuberia]) {
          datosPorTuberia[tuberia] = [];
        }

        datosPorTuberia[tuberia].push({ SS, VmVsm });
      });

      // Asegura orden por SS en cada serie
      Object.values(datosPorTuberia).forEach(serie => {
        serie.sort((a, b) => a.SS - b.SS);
      });

      // Colores limitados (se repiten si hay más tuberías)
      const colores = [
        'rgba(75, 192, 192, 1)',
        'rgba(255, 99, 132, 1)',
        'rgba(54, 162, 235, 1)',
        'rgba(255, 206, 86, 1)',
        'rgba(153, 102, 255, 1)',
        'rgba(255, 159, 64, 1)',
        'rgba(0, 200, 83, 1)',
        'rgba(121, 85, 72, 1)'
      ];

      const datasets = [];
      const tuberias = Object.keys(datosPorTuberia);

      tuberias.forEach((tuberia, index) => {
        datasets.push({
          label: tuberia,
          data: datosPorTuberia[tuberia].map(p => ({ x: p.SS, y: p.VmVsm })),
          borderColor: colores[index % colores.length],
          backgroundColor: colores[index % colores.length],
          tension: 0.2,
          hidden: false
        });
      });

      // Crear checkboxes para filtrar
      const filtroDiv = document.getElementById("filtroTuberias");
      tuberias.forEach((tuberia, i) => {
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.checked = true;
        checkbox.id = `chk_${i}`;

        checkbox.addEventListener("change", () => {
          chart.data.datasets[i].hidden = !checkbox.checked;
          chart.update();
        });

        const label = document.createElement("label");
        label.htmlFor = `chk_${i}`;
        label.textContent = tuberia;

        const container = document.createElement("div");
        container.appendChild(checkbox);
        container.appendChild(label);

        filtroDiv.appendChild(container);
      });

      // Crear el gráfico
      const ctx = document.getElementById('graficoSedimentacion').getContext('2d');
      const chart = new Chart(ctx, {
        type: 'line',
        data: {
          datasets: datasets
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: context => {
                  return `Tubería: ${context.dataset.label}, Vm/Vsm: ${context.parsed.y.toFixed(4)}, %SS: ${context.parsed.x}`;
                }
              }
            },
            title: {
              display: true,
              text: 'Relación Vm/Vsm según concentración de sólidos',
              font: { size: 18 }
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: '% Sólidos en masa'
              }
            },
            y: {
              title: {
                display: true,
                text: 'Vm / Vsm'
              },
              min: 0,
              suggestedMax: 2
            }
          }
        }
      });
    }
  </script>
</body>
</html>


