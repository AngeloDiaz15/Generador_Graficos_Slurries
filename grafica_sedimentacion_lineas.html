<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gráfico de Líneas - Sedimentación</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    canvas {
      max-width: 90%;
      margin: 20px auto;
      display: block;
    }
    select {
      margin: 10px;
    }
  </style>
</head>
<body>
  <h2 style="text-align:center;">Ratio de Sedimentación por Tubería</h2>

  <label for="tuberiaSelect">Filtrar por tubería:</label>
  <select id="tuberiaSelect" onchange="filtrarGrafico()">
    <option value="todos">Mostrar todas</option>
  </select>

  <canvas id="graficoLineas"></canvas>

  <script>
    const colores = [
      'rgba(255, 99, 132, 1)',
      'rgba(54, 162, 235, 1)',
      'rgba(255, 206, 86, 1)',
      'rgba(75, 192, 192, 1)',
      'rgba(153, 102, 255, 1)',
      'rgba(255, 159, 64, 1)',
      'rgba(0, 204, 102, 1)',
      'rgba(255, 0, 255, 1)',
    ];

    const resumenDatos = JSON.parse(localStorage.getItem('resumenDatos') || '[]');
    const datosPorTuberia = {};

    resumenDatos.forEach(row => {
      const tuberia = row[0];
      const ratio = parseFloat(row[5]);
      const porcentajeSS = row[8];

      if (!datosPorTuberia[tuberia]) {
        datosPorTuberia[tuberia] = { x: [], y: [] };
      }

      datosPorTuberia[tuberia].x.push(porcentajeSS);
      datosPorTuberia[tuberia].y.push(ratio);
    });

    const tuberias = Object.keys(datosPorTuberia);
    const tuberiaSelect = document.getElementById("tuberiaSelect");

    tuberias.forEach(t => {
      const option = document.createElement("option");
      option.value = t;
      option.textContent = t;
      tuberiaSelect.appendChild(option);
    });

    const ctx = document.getElementById("graficoLineas").getContext("2d");

    let chart = new Chart(ctx, {
      type: 'line',
      data: {
        datasets: []
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            display: true
          },
          title: {
            display: true,
            text: 'Ratio de Sedimentación (Vm/Vsm) vs % Sólidos'
          }
        },
        scales: {
          x: {
            title: {
              display: true,
              text: '% Sólidos'
            }
          },
          y: {
            title: {
              display: true,
              text: 'Vm/Vsm'
            },
            min: 0,
            max: 2
          }
        }
      }
    });

    function actualizarGrafico(filtro) {
      const datasets = [];
      tuberias.forEach((tuberia, index) => {
        if (filtro !== 'todos' && tuberia !== filtro) return;

        datasets.push({
          label: tuberia,
          data: datosPorTuberia[tuberia].x.map((x, i) => ({
            x,
            y: datosPorTuberia[tuberia].y[i]
          })),
          borderColor: colores[index % colores.length],
          tension: 0.2,
          fill: false
        });
      });

      chart.data.datasets = datasets;
      chart.update();
    }

    function filtrarGrafico() {
      const tuberiaSeleccionada = tuberiaSelect.value;
      actualizarGrafico(tuberiaSeleccionada);
    }

    // Inicializa con todas
    actualizarGrafico('todos');
  </script>
</body>
</html>

