<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Generador de Archivos .fth</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
  <style>
    table, th, td { border: 1px solid black; border-collapse: collapse; padding: 5px; }
    th { background-color: #f2f2f2; }
  </style>
</head>
<body>
  <h2>Generador de configuraciones .fth por % de sólidos</h2>

  <label for="fileInput">Subir archivo .fth:</label>
  <input type="file" id="fileInput" accept=".fth"><br><br>

  <label for="inicio">Desde (%):</label>
  <input type="number" id="inicio" value="5" min="1" max="100">
  <label for="fin">Hasta (%):</label>
  <input type="number" id="fin" value="60" min="1" max="100"><br><br>

  <label for="densidad">Densidad del sólido (kg/m³):</label>
  <input type="number" id="densidad" value="8900" min="1"><br><br>

  <button onclick="generarArchivos()">Generar archivos</button><br><br>
  <a id="descargarZip" style="display:none;">Descargar archivos .zip</a>

  <div id="tablaResultados" style="margin-top:20px;"></div>

  <script>
    function generarArchivos() {
      const input = document.getElementById('fileInput');
      const desde = parseInt(document.getElementById('inicio').value);
      const hasta = parseInt(document.getElementById('fin').value);
      const densidadSolido = parseFloat(document.getElementById('densidad').value);
      const densidadAgua = 1000;

      if (!input.files[0]) {
        alert('Por favor, sube un archivo .fth primero');
        return;
      }
      if (desde < 1 || hasta > 100 || desde > hasta) {
        alert('Rango inválido. Asegúrate de que el rango esté entre 1% y 100% y que el inicio no sea mayor al final.');
        return;
      }
      if (!densidadSolido || isNaN(densidadSolido)) {
        alert('Por favor, ingresa un valor válido de densidad del sólido.');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(event) {
        const contenidoOriginal = event.target.result;
        const zip = new JSZip();
        const regex_conc = /,2,\d{1,3},Percent/g;
        const regex_dens = /,1,kg\/m3,1,\d+(\.\d+)?/g;
        const regex_visco = /,-1,None,0\.001498177,0/g;
        const regex_autoTransfer = /Auto Transfer Results= 0/g;

        let tabla = '<h3>Resultados calculados:</h3><table><tr><th>%SS</th><th>Densidad Mezcla (kg/m³)</th><th>Conc. Volumen</th><th>Viscosidad (Pa·s)</th></tr>';

        for (let ss = desde; ss <= hasta; ss += 5) {
          const fraccionMasa = ss / 100;
          const densidadMezcla = 1 / ((fraccionMasa / densidadSolido) + ((1 - fraccionMasa) / densidadAgua));
          const concVolumen = densidadMezcla * (fraccionMasa / densidadSolido);
          const viscosidad = 0.001 * (1 + (2.5 * concVolumen) + (12.075 * Math.pow(concVolumen, 2)) + (0.00273 * Math.exp(16.6 * concVolumen)));

          tabla += `<tr><td>${ss}</td><td>${densidadMezcla.toFixed(3)}</td><td>${concVolumen.toFixed(5)}</td><td>${viscosidad.toExponential(6)}</td></tr>`;

          let modificado = contenidoOriginal.replaceAll(regex_conc, `,2,${ss},Percent`);
          modificado = modificado.replaceAll(regex_dens, `,1,kg/m3,1,${densidadSolido}`);
          modificado = modificado.replaceAll(regex_visco, `,-1,None,${viscosidad.toFixed(9)},0`);
          modificado = modificado.replaceAll(regex_autoTransfer, 'Auto Transfer Results= 1');

          zip.file(`modelo_${ss}.fth`, modificado);
        }

        tabla += '</table>';
        document.getElementById('tablaResultados').innerHTML = tabla;

        zip.generateAsync({ type: 'blob' })
          .then(function(content) {
            const enlace = document.getElementById('descargarZip');
            enlace.href = URL.createObjectURL(content);
            enlace.download = 'modelos_generados.zip';
            enlace.textContent = 'Descargar modelos_generados.zip';
            enlace.style.display = 'inline';
          });
      };

      reader.readAsText(input.files[0]);
    }
  </script>
</body>
</html>
