<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Generador de Archivos .fth</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    table, th, td { border: 1px solid black; border-collapse: collapse; padding: 5px; }
    th { background-color: #f2f2f2; }
  </style>
</head>
<body>
  <h2>Generador de configuraciones .fth por % de sólidos</h2>

  <label for="fileInput">Subir archivo .fth:</label>
  <input type="file" id="fileInput" accept=".fth"><br><br>

  <label for="inicio">Desde (%):</label>
  <input type="number" id="inicio" value="5" min="1" max="100">
  <label for="fin">Hasta (%):</label>
  <input type="number" id="fin" value="60" min="1" max="100"><br><br>

  <label for="densidad">Densidad del sólido (kg/m³):</label>
  <input type="number" id="densidad" value="8900" min="1"><br><br>

  <label for="rutaFathom">Ruta de AFT Fathom (Fathom.exe):</label><br>
  <input type="text" id="rutaFathom" placeholder="C:\\Program Files (x86)\\AFT Products\\AFT Fathom 12\\Fathom.exe" style="width: 500px;"><br><br>

  <button onclick="generarArchivos()">Generar archivos</button><br><br>
  <a id="descargarZip" style="display:none;">Descargar modelos_generados.zip</a><br><br>
  <a id="descargarBat" style="display:none;">Descargar ejecutar_modelos.bat</a><br><br>
  <a id="descargarXLSX" style="display:none;">Descargar tabla_resultados.xlsx</a><br><br>

  <input type="file" id="resumenInput" multiple accept=".xlsx">
  <button onclick="generarResumenDesdeResultados()">Generar resumen desde resultados</button><br><br>
  <a id="descargarResumen" style="display:none;">Descargar Resumen.xlsx</a><br><br>

  <div id="tablaResultados" style="margin-top:20px;"></div>
  <div id="tablaResumen" style="margin-top:20px;"></div>

  <script>
    // función generarArchivos() ya definida aquí

    async function generarResumenDesdeResultados() {
      const input = document.getElementById('resumenInput');
      if (!input.files.length) {
        alert('Por favor selecciona uno o más archivos .xlsx exportados por Fathom.');
        return;
      }

      const resumen = [["Tubería", "P In (bar)", "P Out (bar)", "Velocidad (m/s)", "Vm/Vsm", "Settling Velocity Max", "Mass Flow Rate", "Vol Flow Slurry", "%SS"]];

      for (const file of input.files) {
        const arrayBuffer = await file.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
        const nombre = file.name;
        const porcentaje = parseInt(nombre.match(/(\d+)(?=\.xlsx)/)?.[1] || 0);

        const sheet = workbook.Sheets[workbook.SheetNames[2]]; // tercera hoja
        if (!sheet) continue;

        const col = (l) => XLSX.utils.sheet_to_json(sheet, { header: 1, range: `${l}1:${l}1000`, blankrows: false }).flat();
        const fromTo = (arr, start) => {
          const s = arr.findIndex((v, i) => i >= start && (v === undefined || v === null || v === "")) + 1;
          const e = arr.findIndex((v, i) => i >= s && (v === undefined || v === null || v === ""));
          return arr.slice(s, e);
        };

        const tuberias = col('A').filter(x => x);
        const pIn = col('M').slice(0, tuberias.length);
        const pOut = col('N').slice(0, tuberias.length);
        const vel = fromTo(col('E'), 0);
        const svmax = fromTo(col('F'), 0);
        const vmvsm = fromTo(col('G'), 0);
        const mfr = fromTo(col('J'), 0);
        const vfs = fromTo(col('K'), 0);

        for (let i = 0; i < tuberias.length; i++) {
          resumen.push([
            tuberias[i],
            parseFloat(pIn[i]),
            parseFloat(pOut[i]),
            parseFloat(vel[i]),
            parseFloat(vmvsm[i]),
            parseFloat(svmax[i]),
            parseFloat(mfr[i]),
            parseFloat(vfs[i]),
            porcentaje
          ]);
        }
      }

      const tabla = document.createElement('table');
      tabla.innerHTML = `<tr>${resumen[0].map(h => `<th>${h}</th>`).join('')}</tr>` +
        resumen.slice(1).map(row => `<tr>${row.map(val => `<td>${val}</td>`).join('')}</tr>`).join('');
      document.getElementById('tablaResumen').innerHTML = '<h3>Resumen combinado:</h3>';
      document.getElementById('tablaResumen').appendChild(tabla);

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(resumen);
      XLSX.utils.book_append_sheet(wb, ws, "Resumen");
      const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
      const blob = new Blob([wbout], { type: 'application/octet-stream' });
      const link = document.getElementById('descargarResumen');
      link.href = URL.createObjectURL(blob);
      link.download = 'Resumen.xlsx';
      link.textContent = 'Descargar Resumen.xlsx';
      link.style.display = 'inline';
    }
  </script>
</body>
</html>

