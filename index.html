<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Generador de Archivos .fth</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    table, th, td { border: 1px solid black; border-collapse: collapse; padding: 5px; }
    th { background-color: #f2f2f2; }
  </style>
</head>
<body>
  <h2>Generador de configuraciones .fth por % de sólidos</h2>

  <label for="fileInput">Subir archivo .fth:</label>
  <input type="file" id="fileInput" accept=".fth"><br><br>

  <label for="inicio">Desde (%):</label>
  <input type="number" id="inicio" value="5" min="1" max="100">
  <label for="fin">Hasta (%):</label>
  <input type="number" id="fin" value="60" min="1" max="100"><br><br>

  <label for="densidad">Densidad del sólido (kg/m³):</label>
  <input type="number" id="densidad" value="8900" min="1"><br><br>

  <label for="rutaFathom">Ruta de AFT Fathom (Fathom.exe):</label><br>
  <input type="text" id="rutaFathom" placeholder="C:\\Program Files (x86)\\AFT Products\\AFT Fathom 12\\Fathom.exe" style="width: 500px;"><br><br>

  <button onclick="generarArchivos()">Generar archivos</button><br><br>
  <a id="descargarZip" style="display:none;">Descargar modelos_generados.zip</a><br><br>
  <a id="descargarBat" style="display:none;">Descargar ejecutar_modelos.bat</a><br><br>
  <a id="descargarXLSX" style="display:none;">Descargar tabla_resultados.xlsx</a><br><br>

  <h3>Resumen combinado de resultados</h3>
  <input type="file" id="archivosXLSX" multiple accept=".xlsx">
  <button onclick="generarResumen()">Generar resumen desde resultados</button><br><br>
  <a id="descargarResumen" style="display:none;">Descargar Resumen.xlsx</a>
  <div id="tablaResumen"></div>

  <div id="tablaResultados" style="margin-top:20px;"></div>

  <script>
    function generarArchivos() {
      const input = document.getElementById('fileInput');
      const desde = parseInt(document.getElementById('inicio').value);
      const hasta = parseInt(document.getElementById('fin').value);
      const densidadSolido = parseFloat(document.getElementById('densidad').value);
      const densidadAgua = 1000;
      const rutaFathom = document.getElementById('rutaFathom').value.trim();

      if (!input.files[0]) return alert('Por favor, sube un archivo .fth primero');
      if (desde < 1 || hasta > 100 || desde > hasta) return alert('Rango inválido.');
      if (!densidadSolido || isNaN(densidadSolido)) return alert('Densidad inválida.');
      if (!rutaFathom) return alert('Escribe la ruta de AFT Fathom.');

      const reader = new FileReader();
      reader.onload = function(event) {
        const contenidoOriginal = event.target.result;
        const zip = new JSZip();
        const regex_conc = /,2,\d{1,3},Percent/g;
        const regex_dens = /,1,kg\/m3,1,\d+(\.\d+)?/g;
        const regex_visco = /,-1,None,0\.001498177,0/g;
        const regex_autoTransfer = /Auto Transfer Results= 0/g;

        let tabla = '<h3>Resultados calculados:</h3><table><tr><th>%SS</th><th>Densidad Mezcla</th><th>Conc. Volumen</th><th>Viscosidad</th></tr>';
        const datosExcel = [["%SS", "Densidad Mezcla", "Conc. Volumen", "Viscosidad"]];
        let nombres = [];

        for (let ss = desde; ss <= hasta; ss += 5) {
          const fraccionMasa = ss / 100;
          const densidadMezcla = 1 / ((fraccionMasa / densidadSolido) + ((1 - fraccionMasa) / densidadAgua));
          const concVolumen = densidadMezcla * (fraccionMasa / densidadSolido);
          const viscosidad = 0.001 * (1 + 2.5 * concVolumen + 12.075 * concVolumen**2 + 0.00273 * Math.exp(16.6 * concVolumen));

          tabla += `<tr><td>${ss}</td><td>${densidadMezcla.toFixed(3)}</td><td>${concVolumen.toFixed(5)}</td><td>${viscosidad.toExponential(6)}</td></tr>`;
          datosExcel.push([ss, parseFloat(densidadMezcla.toFixed(3)), parseFloat(concVolumen.toFixed(5)), parseFloat(viscosidad.toExponential(6))]);

          let modificado = contenidoOriginal.replaceAll(regex_conc, `,2,${ss},Percent`)
            .replaceAll(regex_dens, `,1,kg/m3,1,${densidadSolido}`)
            .replaceAll(regex_visco, `,-1,None,${viscosidad.toFixed(9)},0`)
            .replaceAll(regex_autoTransfer, 'Auto Transfer Results= 1');

          const nombre = `modelo_${ss}`;
          nombres.push(nombre);
          zip.file(`${nombre}.fth`, modificado);
        }

        tabla += '</table>';
        document.getElementById('tablaResultados').innerHTML = tabla;

        zip.generateAsync({ type: 'blob' }).then(content => {
          const enlace = document.getElementById('descargarZip');
          enlace.href = URL.createObjectURL(content);
          enlace.download = 'modelos_generados.zip';
          enlace.textContent = 'Descargar modelos_generados.zip';
          enlace.style.display = 'inline';
        });

        const bat = `@echo off\nsetlocal enabledelayedexpansion\nset FATHOM_PATH=\"${rutaFathom}\"\nset MODELS_DIR=\"%~dp0modelos_generados\"\nset OUTPUT_DIR=\"%~dp0resultados_exportados\"\nif not exist %OUTPUT_DIR% ( mkdir %OUTPUT_DIR% )\necho Ejecutando modelos...\nfor %%f in (%MODELS_DIR%\\*.fth) do ( echo Procesando %%~nxf... & %FATHOM_PATH% \"%%f\" /Run /ExportOutput \"%OUTPUT_DIR%\\%%~nf.xlsx\" )\necho.\necho ✅ Finalizado.\npause\n`;

        const blobBat = new Blob([bat], { type: 'text/plain' });
        const batLink = document.getElementById('descargarBat');
        batLink.href = URL.createObjectURL(blobBat);
        batLink.download = 'ejecutar_modelos.bat';
        batLink.textContent = 'Descargar ejecutar_modelos.bat';
        batLink.style.display = 'inline';

        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(datosExcel);
        XLSX.utils.book_append_sheet(wb, ws, "Resultados");
        const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
        const blobExcel = new Blob([wbout], { type: 'application/octet-stream' });
        const excelLink = document.getElementById('descargarXLSX');
        excelLink.href = URL.createObjectURL(blobExcel);
        excelLink.download = 'tabla_resultados.xlsx';
        excelLink.textContent = 'Descargar tabla_resultados.xlsx';
        excelLink.style.display = 'inline';
      };
      reader.readAsText(input.files[0]);
    }

    function generarResumen() {
      const input = document.getElementById('archivosXLSX');
      if (!input.files.length) return alert('Selecciona archivos .xlsx generados por Fathom.');

      const tablaResumen = document.getElementById('tablaResumen');
      let datosCombinados = [["%SS", "Pipe", "P In (bar)", "P Out (bar)", "Velocity", "Vsettle Max", "Vm/Vsm", "Mass Flow", "Vol Flow"]];
      let tablaHTML = '<table><tr><th>%SS</th><th>Pipe</th><th>P In</th><th>P Out</th><th>Velocity</th><th>Vsettle Max</th><th>Vm/Vsm</th><th>Mass Flow</th><th>Vol Flow</th></tr>';

      let archivosProcesados = 0;
      Array.from(input.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = e => {
          const workbook = XLSX.read(e.target.result, { type: 'binary' });
          const hoja = workbook.SheetNames[2];
          const data = XLSX.utils.sheet_to_json(workbook.Sheets[hoja], { header: 1 });

          const ss = parseInt(file.name.match(/(\d+)(?=\.xlsx$)/)?.[0] || 0);
          const A = data.slice(2).map(r => r[0]).filter(v => v != null);
          const E = data.slice(2).map(r => r[4]).filter(v => v != null);
          const F = data.slice(2).map(r => r[5]).filter(v => v != null);
          const G = data.slice(2).map(r => r[6]).filter(v => v != null);
          const J = data.slice(2).map(r => r[9]).filter(v => v != null);
          const K = data.slice(2).map(r => r[10]).filter(v => v != null);
          const M = data.slice(2).map(r => r[12]).filter(v => v != null);
          const N = data.slice(2).map(r => r[13]).filter(v => v != null);

          for (let i = 0; i < A.length; i++) {
            datosCombinados.push([ss, A[i], M[i], N[i], E[i], F[i], G[i], J[i], K[i]]);
            tablaHTML += `<tr><td>${ss}</td><td>${A[i]}</td><td>${M[i]}</td><td>${N[i]}</td><td>${E[i]}</td><td>${F[i]}</td><td>${G[i]}</td><td>${J[i]}</td><td>${K[i]}</td></tr>`;
          }

          archivosProcesados++;
          if (archivosProcesados === input.files.length) {
            tablaHTML += '</table>';
            tablaResumen.innerHTML = tablaHTML;

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(datosCombinados);
            XLSX.utils.book_append_sheet(wb, ws, "Resumen");
            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            const blobResumen = new Blob([wbout], { type: 'application/octet-stream' });

            const link = document.getElementById('descargarResumen');
            link.href = URL.createObjectURL(blobResumen);
            link.download = 'Resumen.xlsx';
            link.textContent = 'Descargar Resumen.xlsx';
            link.style.display = 'inline';
          }
        };
        reader.readAsBinaryString(file);
      });
    }
  </script>
</body>
</html>
