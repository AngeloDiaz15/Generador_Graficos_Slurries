<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tabla de Cavitación</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    .rojo { background-color: #ff4d4d; color: white; }
    .rojo-claro { background-color: #ff9999; }
    .amarillo { background-color: #ffff99; }
    .verde { background-color: #ccffcc; }
    input, select { margin: 5px; padding: 5px; }
  </style>
</head>
<body>
  <h2>Visualización de Cavitación</h2>

  <label for="tipoPresion">Tipo de presión a mostrar:</label>
  <select id="tipoPresion">
    <option value="entrada">Presión de Entrada</option>
    <option value="salida">Presión de Salida</option>
    <option value="minima">Presión Mínima</option>
  </select>

  <label for="presionVapor">Presión de vapor [bar]:</label>
  <input type="number" id="presionVapor" value="0.0234" step="0.0001" />

  <button onclick="generarTabla()">Generar tabla</button>

  <div id="tablaContainer"></div>

<script>
  const resumenDatos = JSON.parse(localStorage.getItem("resumenDatos")) || [];

  function generarTabla() {
    const tipoPresion = document.getElementById("tipoPresion").value;
    const presionVapor = parseFloat(document.getElementById("presionVapor").value);
    const datosPorTuberia = {};

    resumenDatos.forEach(fila => {
      const tuberia = fila[0];
      const ss = parseFloat(fila[8]);

      const pin = parseFloat(String(fila[1]).replace(/[^\d.-]/g, ''));
      const pout = parseFloat(String(fila[2]).replace(/[^\d.-]/g, ''));

      let valor = null;
      if (tipoPresion === "entrada") valor = pin;
      else if (tipoPresion === "salida") valor = pout;
      else if (tipoPresion === "minima") valor = Math.min(pin, pout);

      if (!datosPorTuberia[tuberia]) datosPorTuberia[tuberia] = {};
      datosPorTuberia[tuberia][ss] = valor;
    });

    const ssUnicos = [...new Set(resumenDatos.map(fila => parseFloat(fila[8])))].sort((a, b) => a - b);
    const tuberias = Object.keys(datosPorTuberia);

    const tabla = document.createElement("table");

    const thead = document.createElement("thead");
    const filaEncabezado = document.createElement("tr");
    filaEncabezado.innerHTML = "<th>Tubería</th>";
    ssUnicos.forEach(ss => {
      filaEncabezado.innerHTML += `<th>${ss}%</th>`;
    });
    thead.appendChild(filaEncabezado);
    tabla.appendChild(thead);

    const tbody = document.createElement("tbody");
    tuberias.forEach(tuberia => {
      const fila = document.createElement("tr");
      fila.innerHTML = `<td>${tuberia}</td>`;

      ssUnicos.forEach(ss => {
        const valor = datosPorTuberia[tuberia][ss];
        let clase = "blanco";
        let texto = "";

        if (valor !== undefined && !isNaN(valor)) {
          texto = valor.toFixed(4);
          if (valor < presionVapor) clase = "rojo-oscuro";
          else if (valor === presionVapor || (valor < 1 && valor > presionVapor)) clase = "rojo-claro";
          else if (valor >= 1 && valor <= 5) clase = "naranja";
          else if (valor > 5 && valor < 15) clase = "amarillo";
        }

        fila.innerHTML += `<td class="${clase}">${texto}</td>`;
      });

      tbody.appendChild(fila);
    });

    tabla.appendChild(tbody);

    const tablaContenedor = document.getElementById("tablaCalor");
    tablaContenedor.innerHTML = ""; // limpia anterior
    tablaContenedor.appendChild(tabla);
  }

  function descargarComoImagen() {
    const tablaElemento = document.getElementById("tablaCalor");
    html2canvas(tablaElemento).then(canvas => {
      const link = document.createElement("a");
      link.download = "mapa_calor.jpg";
      link.href = canvas.toDataURL("image/jpeg", 1.0);
      link.click();
    });
  }

  // Render inicial
  generarTabla();
</script>

  
</body>
</html>



