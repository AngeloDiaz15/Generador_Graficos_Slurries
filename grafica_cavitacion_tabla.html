<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tabla de Cavitación</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    .rojo { background-color: #ff4d4d; color: white; }
    .rojo-claro { background-color: #ff9999; }
    .amarillo { background-color: #ffff99; }
    .verde { background-color: #ccffcc; }
    input, select { margin: 5px; padding: 5px; }
  </style>
</head>
<body>
  <h2>Visualización de Cavitación</h2>

  <label for="tipoPresion">Tipo de presión a mostrar:</label>
  <select id="tipoPresion">
    <option value="entrada">Presión de Entrada</option>
    <option value="salida">Presión de Salida</option>
    <option value="minima">Presión Mínima</option>
  </select>

  <label for="presionVapor">Presión de vapor [bar]:</label>
  <input type="number" id="presionVapor" value="0.0234" step="0.0001" />

  <button onclick="generarTabla()">Generar tabla</button>

  <div id="tablaContainer"></div>

  <script>
    function generarTabla() {
      const resumenDatos = JSON.parse(localStorage.getItem("resumenDatos") || "[]");
      const tipoPresion = document.getElementById("tipoPresion").value;
      const presionVapor = parseFloat(document.getElementById("presionVapor").value);

      const datosPorTuberia = {};

      resumenDatos.forEach(fila => {
        const tuberia = fila[0];
        const ss = parseFloat(fila[8]);

        const pin = parseFloat(String(fila[1]).replace(/[^\d.-]/g, ''));
        const pout = parseFloat(String(fila[2]).replace(/[^\d.-]/g, ''));

        let valor = null;
        if (tipoPresion === "entrada") valor = pin;
        else if (tipoPresion === "salida") valor = pout;
        else if (tipoPresion === "minima") valor = Math.min(pin, pout);

        if (!datosPorTuberia[tuberia]) datosPorTuberia[tuberia] = {};
        datosPorTuberia[tuberia][ss] = valor;
      });

      const tuberias = Object.keys(datosPorTuberia).sort();
      const porcentajes = [...new Set(resumenDatos.map(f => parseFloat(f[8])))].sort((a, b) => a - b);

      let tablaHTML = "<table><thead><tr><th>Tubería</th>";
      porcentajes.forEach(ss => tablaHTML += `<th>${ss}%</th>`);
      tablaHTML += "</tr></thead><tbody>";

      tuberias.forEach(tuberia => {
        tablaHTML += `<tr><td>${tuberia}</td>`;
        porcentajes.forEach(ss => {
          const valor = datosPorTuberia[tuberia][ss];
          let clase = "";

          if (valor < presionVapor) clase = "rojo";
          else if (Math.abs(valor - presionVapor) < 0.00001 || (valor < 1 && valor > presionVapor)) clase = "rojo-claro";
          else if (valor < 1.5) clase = "amarillo";
          else clase = "verde";

          tablaHTML += `<td class="${clase}">${valor?.toFixed(3) ?? "-"}</td>`;
        });
        tablaHTML += "</tr>";
      });

      tablaHTML += "</tbody></table>";
      document.getElementById("tablaContainer").innerHTML = tablaHTML;
    }

    // Auto-generar la tabla al cargar si hay datos
    window.onload = () => {
      if (localStorage.getItem("resumenDatos")) {
        generarTabla();
      }
    };
  </script>
</body>
</html>



