<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mapa de Calor de Vm/Vsm (Tabla)</title>
  <style>
    table {
      border-collapse: collapse;
      margin: 20px auto;
      font-family: Arial, sans-serif;
      width: 90%;
    }
    th, td {
      border: 1px solid #999;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #eee;
    }
    .rojo-oscuro {
      background-color: #a94442;
      color: white;
    }
    .rojo-claro {
      background-color: #f2dede;
    }
    .naranja {
      background-color: #f0ad4e;
    }
    .amarillo {
      background-color: #fcf8e3;
    }
  </style>
</head>
<body>
  <h2 style="text-align:center">Mapa de Calor de Vm/Vsm por Tubería y %SS</h2>
  <div id="tabla-container"></div>

  <script>
    const datos = JSON.parse(localStorage.getItem('resumenDatos')) || [];

    // Organizar los datos en un diccionario por tubería
    const datosPorTuberia = {};
    const porcentajesSS = new Set();

    datos.forEach(fila => {
      const tuberia = fila[0];
      const VmVsm = parseFloat(fila[5]);
      const ss = parseFloat(fila[8]);

      if (!datosPorTuberia[tuberia]) {
        datosPorTuberia[tuberia] = {};
      }
      datosPorTuberia[tuberia][ss] = VmVsm;
      porcentajesSS.add(ss);
    });

    const porcentajesOrdenados = Array.from(porcentajesSS).sort((a, b) => a - b);

    // Crear tabla
    let tablaHTML = '<table><thead><tr><th>Tubería</th>';
    porcentajesOrdenados.forEach(ss => {
      tablaHTML += `<th>${ss}%</th>`;
    });
    tablaHTML += '</tr></thead><tbody>';

    Object.keys(datosPorTuberia).forEach(tuberia => {
      tablaHTML += `<tr><td>${tuberia}</td>`;
      porcentajesOrdenados.forEach(ss => {
        const valor = datosPorTuberia[tuberia][ss];
        let clase = '';
        let contenido = '-';
        if (typeof valor === 'number' && !isNaN(valor)) {
          contenido = valor.toFixed(3);
          if (valor < 1) {
            clase = 'rojo-oscuro';
          } else if (valor >= 1 && valor <= 1.05) {
            clase = 'rojo-claro';
          } else if (valor > 1.05 && valor <= 1.1) {
            clase = 'naranja';
          } else if (valor > 1.1 && valor <= 1.3) {
            clase = 'amarillo';
          }
        }
        tablaHTML += `<td class="${clase}">${contenido}</td>`;
      });
      tablaHTML += '</tr>';
    });

    tablaHTML += '</tbody></table>';
    document.getElementById('tabla-container').innerHTML = tablaHTML;
  </script>
</body>
</html>
