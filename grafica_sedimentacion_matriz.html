<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gráfica y Mapa de Calor Vm/Vsm</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    #graficoContainer {
      width: 100%;
      height: 500px;
    }
    canvas {
      width: 100% !important;
      height: 100% !important;
    }
    .mensaje {
      margin-top: 15px;
      font-size: 14px;
      color: darkred;
    }
    table {
      border-collapse: collapse;
      margin-top: 40px;
      width: 100%;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px;
      text-align: center;
    }
  </style>
</head>
<body>

<h2>Gráfico de líneas Vm/Vsm por Tubería</h2>
<div id="graficoContainer">
  <canvas id="graficoLineas"></canvas>
</div>
<div id="mensajes" class="mensaje"></div>

<h2>Mapa de calor tipo tabla</h2>
<div id="tablaContainer"></div>

<script>
  const datos = JSON.parse(localStorage.getItem('resumenDatos')) || [];

  const porcentajes = [...new Set(datos.map(d => d['%SS']))].sort((a, b) => a - b);
  const tuberias = [...new Set(datos.map(d => d['Tubería']))];

  // === Gráfico de líneas ===
  const datasets = tuberias.map(tuberia => {
    const puntos = datos.filter(d => d['Tubería'] === tuberia).map(d => ({
      x: d['%SS'],
      y: d['Vm/Vsm']
    }));
    return {
      label: tuberia,
      data: puntos,
      borderWidth: 2,
      fill: false
    };
  });

  const ctx = document.getElementById('graficoLineas').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: {
      datasets
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          type: 'linear',
          title: {
            display: true,
            text: '% Sólidos'
          }
        },
        y: {
          title: {
            display: true,
            text: 'Vm/Vsm'
          }
        }
      },
      plugins: {
        legend: {
          position: 'right'
        },
        annotation: {
          annotations: {
            lineaReferencia: {
              type: 'line',
              yMin: 1,
              yMax: 1,
              borderColor: 'red',
              borderWidth: 2,
              label: {
                enabled: true,
                content: 'Vm/Vsm = 1',
                position: 'end'
              }
            }
          }
        }
      }
    },
    plugins: [{
      id: 'customLine',
      beforeDraw(chart) {
        const mensajes = [];
        datos.forEach(d => {
          if (d['Vm/Vsm'] < 1) {
            mensajes.push(`La velocidad en la tubería ${d['Tubería']} (${d['Vm'].toFixed(2)} m/s) es menor que la velocidad de sedimentación (${d['Vsm'].toFixed(2)} m/s) a una concentración de sólido de ${d['%SS']}%.`);
          }
        });
        document.getElementById('mensajes').innerHTML = mensajes.join('<br>');
      }
    }]
  });

  // === Mapa de calor tipo tabla ===
  const tabla = document.createElement('table');
  const headerRow = document.createElement('tr');
  headerRow.innerHTML = `<th>Tubería</th>` + porcentajes.map(p => `<th>${p}%</th>`).join('');
  tabla.appendChild(headerRow);

  tuberias.forEach(tuberia => {
    const row = document.createElement('tr');
    row.innerHTML = `<td>${tuberia}</td>`;
    porcentajes.forEach(p => {
      const valor = datos.find(d => d['Tubería'] === tuberia && d['%SS'] === p);
      const celda = document.createElement('td');
      if (valor && valor['Vm/Vsm'] != null) {
        const v = valor['Vm/Vsm'];
        celda.textContent = v.toFixed(2);
        if (v < 1) celda.style.backgroundColor = '#8B0000'; // rojo oscuro
        else if (v <= 1.05) celda.style.backgroundColor = '#FF6347'; // rojo claro
        else if (v <= 1.1) celda.style.backgroundColor = '#FFA500'; // naranja
        else if (v <= 1.3) celda.style.backgroundColor = '#FFFF00'; // amarillo
      }
      row.appendChild(celda);
    });
    tabla.appendChild(row);
  });

  document.getElementById('tablaContainer').appendChild(tabla);
</script>
</body>
</html>

