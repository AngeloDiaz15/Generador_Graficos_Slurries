<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gráficas de Sedimentación</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
    }

    #grafico {
      width: 100%;
      height: 500px;
    }

    .tabla-container {
      overflow-x: auto;
      margin-top: 50px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 100%;
    }

    th, td {
      border: 1px solid #999;
      padding: 8px;
      text-align: center;
    }

    .rojo-oscuro { background-color: #8B0000; color: white; }
    .rojo-claro { background-color: #FF6347; color: white; }
    .naranja { background-color: #FFA500; }
    .amarillo { background-color: #FFFF99; }

    #mensajes {
      margin-top: 20px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h2>Gráfico Línea: Vm/Vsm por Tubería</h2>
  <div>
    <label for="tuberiaSelect">Selecciona una tubería:</label>
    <select id="tuberiaSelect"></select>
  </div>
  <canvas id="grafico"></canvas>
  <div id="mensajes"></div>

  <h2 style="margin-top: 60px;">Mapa de Calor (Tabla)</h2>
  <div class="tabla-container">
    <table id="tablaHeatmap"></table>
  </div>

  <script>
    const resumenDatos = JSON.parse(localStorage.getItem('resumenDatos'));

    const tuberias = [...new Set(resumenDatos.map(item => item.Tuberia))];
    const porcentajes = [...new Set(resumenDatos.map(item => item["%SS"]))].sort((a, b) => a - b);

    // Gráfico de líneas
    const tuberiaSelect = document.getElementById('tuberiaSelect');
    const mensajesDiv = document.getElementById('mensajes');
    const ctx = document.getElementById('grafico').getContext('2d');

    tuberias.forEach(tub => {
      const option = document.createElement('option');
      option.value = tub;
      option.textContent = tub;
      tuberiaSelect.appendChild(option);
    });

    let chart;

    function actualizarGrafico(tuberia) {
      const datosTuberia = resumenDatos.filter(d => d.Tuberia === tuberia).sort((a, b) => a["%SS"] - b["%SS"]);
      const data = {
        labels: datosTuberia.map(d => d["%SS"]),
        datasets: [{
          label: `Vm/Vsm - ${tuberia}`,
          data: datosTuberia.map(d => d["Vm/Vsm"]),
          borderColor: 'blue',
          tension: 0.2,
          fill: false
        }, {
          label: 'Referencia = 1',
          data: datosTuberia.map(() => 1),
          borderColor: 'red',
          borderDash: [5, 5],
          pointRadius: 0,
          tension: 0
        }]
      };

      const config = {
        type: 'line',
        data: data,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right'
            }
          },
          scales: {
            x: { title: { display: true, text: '% de Sólidos' } },
            y: { title: { display: true, text: 'Vm/Vsm' } }
          }
        }
      };

      if (chart) chart.destroy();
      chart = new Chart(ctx, config);

      // Mensajes
      mensajesDiv.innerHTML = '';
      datosTuberia.forEach(d => {
        const valor = d["Vm/Vsm"];
        const vsm = d["Velocidad de sedimentación"];
        const vm = d["Velocidad"];
        const ss = d["%SS"];

        if (valor !== undefined && valor < 1) {
          const msg = `La velocidad en la tubería "${d.Tuberia}" (${vm?.toFixed(2)} m/s) es menor que la velocidad de sedimentación (${vsm?.toFixed(2)} m/s) a una concentración de sólido de ${ss}%.<br>`;
          mensajesDiv.innerHTML += msg;
        }
      });
    }

    tuberiaSelect.addEventListener('change', (e) => {
      actualizarGrafico(e.target.value);
    });

    actualizarGrafico(tuberias[0]);

    // === Tabla Heatmap ===
    const tabla = document.getElementById('tablaHeatmap');

    // Crear encabezado
    const headerRow = document.createElement('tr');
    const thVacio = document.createElement('th');
    thVacio.textContent = "Tubería / %SS";
    headerRow.appendChild(thVacio);
    porcentajes.forEach(p => {
      const th = document.createElement('th');
      th.textContent = `${p}%`;
      headerRow.appendChild(th);
    });
    tabla.appendChild(headerRow);

    // Crear filas por tubería
    tuberias.forEach(tub => {
      const row = document.createElement('tr');
      const th = document.createElement('th');
      th.textContent = tub;
      row.appendChild(th);

      porcentajes.forEach(p => {
        const cell = document.createElement('td');
        const valorObj = resumenDatos.find(d => d.Tuberia === tub && d["%SS"] === p);
        const valor = valorObj?.["Vm/Vsm"];

        if (valor !== undefined) {
          cell.textContent = valor.toFixed(2);
          if (valor < 1) {
            cell.classList.add("rojo-oscuro");
          } else if (valor <= 1.05) {
            cell.classList.add("rojo-claro");
          } else if (valor <= 1.1) {
            cell.classList.add("naranja");
          } else if (valor <= 1.3) {
            cell.classList.add("amarillo");
          }
        } else {
          cell.textContent = "-";
        }

        row.appendChild(cell);
      });

      tabla.appendChild(row);
    });
  </script>
</body>
</html>


