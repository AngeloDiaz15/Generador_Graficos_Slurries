<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Visualización de Sedimentación</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial; margin: 20px; }
    canvas { max-width: 100%; }
    table { border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #aaa; padding: 5px 10px; text-align: center; }
    th { background-color: #f2f2f2; }
  </style>
</head>
<body>
  <h2>Visualización de Sedimentación</h2>

  <h3>Gráfico de Líneas Múltiples (Vm/Vsm según tubería)</h3>
  <canvas id="graficoLineas" height="300"></canvas>

  <h3>Resumen con tabla Interactiva (Rojo si Vm/Vsm &lt; 1)</h3>
  <div id="tablaSedimentacion"></div>

  <h3>Tendencias con mapa de Calor de Vm/Vsm</h3>
  <canvas id="mapaCalor" height="400"></canvas>

  <script>
    const resumen = JSON.parse(localStorage.getItem("resumenDatos") || "[]");
    const tuberias = [...new Set(resumen.map(r => r[0]))];
    const concentraciones = [...new Set(resumen.map(r => r[8]))].sort((a, b) => a - b);

    const datosPorTuberia = {};
    tuberias.forEach(t => datosPorTuberia[t] = {});
    resumen.forEach(r => {
      const [t, , , , , vmvsm, , , ss] = r;
      if (tuberias.includes(t)) {
        datosPorTuberia[t][ss] = parseFloat(vmvsm) || 0;
      }
    });

    // ====== GRÁFICO DE LÍNEAS MÚLTIPLES ======
    function generarColor(i) {
      const h = (i * 137.508) % 360; // buena dispersión
      return `hsl(${h}, 70%, 50%)`;
    }

    function crearGraficoLineas() {
      const datasets = tuberias.map((t, i) => ({
        label: t,
        data: concentraciones.map(ss => datosPorTuberia[t][ss] ?? null),
        fill: false,
        borderColor: generarColor(i),
        tension: 0.1
      }));

      new Chart(document.getElementById("graficoLineas").getContext("2d"), {
        type: 'line',
        data: {
          labels: concentraciones.map(c => c + "%"),
          datasets: datasets
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            title: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: "Vm/Vsm" }
            },
            x: {
              title: { display: true, text: "%SS" }
            }
          }
        }
      });
    }

    // ====== TABLA INTERACTIVA ======
    function crearTabla() {
      let html = '<table><thead><tr><th>Tubería</th>' +
        concentraciones.map(c => `<th>${c}%</th>`).join('') +
        '</tr></thead><tbody>';

      tuberias.forEach(t => {
        html += `<tr><td>${t}</td>`;
        concentraciones.forEach(c => {
          const val = datosPorTuberia[t][c];
          const color = val < 1 ? ' style="background-color:#f99;"' : '';
          html += `<td${color}>${val?.toFixed(3) ?? ""}</td>`;
        });
        html += '</tr>';
      });
      html += '</tbody></table>';
      document.getElementById('tablaSedimentacion').innerHTML = html;
    }

    // ====== MAPA DE CALOR ======
    function crearMapaCalor() {
      const valores = tuberias.map(t => concentraciones.map(c => datosPorTuberia[t][c] ?? null));
      const datasets = [{
        label: "Mapa de calor Vm/Vsm",
        data: valores.flatMap((row, i) =>
          row.map((v, j) => ({ x: j, y: i, v }))
        ).filter(p => p.v !== null),
        backgroundColor(ctx) {
          const value = ctx.raw.v;
          const ratio = Math.min(Math.max((value - 0.5) / 2, 0), 1);
          const hue = ratio * 120;
          return `hsl(${hue}, 80%, 50%)`;
        },
        borderWidth: 1,
        borderColor: "#333",
        width: ({ chart }) => chart.chartArea.width / concentraciones.length - 2,
        height: ({ chart }) => chart.chartArea.height / tuberias.length - 2,
      }];

      new Chart(document.getElementById("mapaCalor").getContext("2d"), {
        type: 'matrix',
        data: {
          datasets: datasets
        },
        options: {
          plugins: {
            tooltip: {
              callbacks: {
                title: (items) => {
                  const i = items[0].raw.y;
                  const j = items[0].raw.x;
                  return `${tuberias[i]}, ${concentraciones[j]}%`;
                },
                label: (item) => `Vm/Vsm: ${item.raw.v.toFixed(3)}`
              }
            },
            legend: { display: false }
          },
          scales: {
            x: {
              type: "linear",
              min: 0,
              max: concentraciones.length,
              ticks: {
                callback: v => concentraciones[v] + "%"
              },
              title: { display: true, text: "%SS" }
            },
            y: {
              type: "linear",
              min: 0,
              max: tuberias.length,
              ticks: {
                callback: v => tuberias[v]
              },
              title: { display: true, text: "Tubería" }
            }
          }
        }
      });
    }

    window.onload = () => {
      crearGraficoLineas();
      crearTabla();

      // Cargar plugin de matrix chart antes de graficar
      Chart.register({
        id: 'matrix',
        beforeInit(chart) {
          if (chart.config.type === 'matrix') {
            const matrixController = Chart.controllers.bar.extend({
              dataElementType: Chart.elements.Rectangle,
              updateElements(rects, start, count, mode) {
                for (let i = start; i < start + count; i++) {
                  const rect = rects[i];
                  const raw = this.getDataset().data[i];
                  const vp = this._cachedMeta.vScale.getPixelForValue(raw.y);
                  const hp = this._cachedMeta.iScale.getPixelForValue(raw.x);
                  rect.x = hp;
                  rect.y = vp;
                  rect.width = this.getDataset().width(this.chart);
                  rect.height = this.getDataset().height(this.chart);
                  rect.options.backgroundColor = this.getDataset().backgroundColor({ raw });
                  rect.options.borderColor = this.getDataset().borderColor;
                  rect.options.borderWidth = this.getDataset().borderWidth;
                }
              }
            });
            Chart.controllers.matrix = matrixController;
          }
        }
      });

      crearMapaCalor();
    };
  </script>
</body>
</html>
