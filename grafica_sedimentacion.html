<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Visualización de Sedimentación</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@1.1.0/dist/chartjs-chart-matrix.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
    }
    canvas {
      max-width: 100%;
      margin-bottom: 40px;
    }
    table {
      border-collapse: collapse;
      margin-bottom: 40px;
      width: 100%;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
    }
    th {
      background-color: #f2f2f2;
    }
    td.vmvsm-low {
      background-color: #f99;
    }
  </style>
</head>
<body>
  <h2>Visualización de Sedimentación</h2>
  <canvas id="lineChart" height="300"></canvas>

  <h3>Tabla interactiva Vm/Vsm</h3>
  <div id="tablaVmVsm"></div>

  <h3>Mapa de calor de Vm/Vsm por tubería y %SS</h3>
  <canvas id="heatmapChart" width="900" height="500"></canvas>

  <script>
    const dataRaw = JSON.parse(localStorage.getItem('resumenDatos') || '[]');

    if (!dataRaw.length) {
      document.body.innerHTML = "<h3 style='color:red'>⚠ Primero genera el resumen desde los resultados en index.html</h3>";
      throw new Error("No hay datos en localStorage");
    }

    const headers = ["Tubería", "P Static In", "P Static Out", "Velocity", "Settling V Max", "Vm/Vsm", "Mass Flow", "Vol Flow", "%SS"];
    const data = dataRaw.map(arr => ({
      tuberia: arr[0],
      pIn: parseFloat(arr[1]),
      pOut: parseFloat(arr[2]),
      velocity: parseFloat(arr[3]),
      settling: parseFloat(arr[4]),
      vmvsm: parseFloat(arr[5]),
      massFlow: parseFloat(arr[6]),
      volFlow: parseFloat(arr[7]),
      ss: parseInt(arr[8])
    }));

    // === GRÁFICO DE LÍNEAS MÚLTIPLES ===
    function renderizarLineas(data) {
      const tuberias = [...new Set(data.map(d => d.tuberia))];
      const datasets = tuberias.map((tub, i) => {
        const color = `hsl(${(i * 360 / tuberias.length)}, 70%, 50%)`;
        return {
          label: tub,
          data: data.filter(d => d.tuberia === tub).map(d => ({ x: d.ss, y: d.vmvsm })),
          borderColor: color,
          backgroundColor: color,
          tension: 0.2
        };
      });

      const ctx = document.getElementById('lineChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: { datasets },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: 'Evolución de Vm/Vsm por tubería'
            }
          },
          scales: {
            x: {
              type: 'linear',
              title: { display: true, text: '%SS' }
            },
            y: {
              title: { display: true, text: 'Vm/Vsm' }
            }
          }
        }
      });
    }

    // === TABLA INTERACTIVA ===
    function renderizarTabla(data) {
      const tuberias = [...new Set(data.map(d => d.tuberia))];
      const concentraciones = [...new Set(data.map(d => d.ss))].sort((a, b) => a - b);

      let tabla = '<table><thead><tr><th>Tubería</th>' + 
                  concentraciones.map(ss => `<th>${ss}%</th>`).join('') + 
                  '</tr></thead><tbody>';

      for (const tub of tuberias) {
        tabla += `<tr><td>${tub}</td>`;
        for (const ss of concentraciones) {
          const punto = data.find(d => d.tuberia === tub && d.ss === ss);
          const clase = punto && punto.vmvsm < 1 ? 'vmvsm-low' : '';
          const valor = punto ? punto.vmvsm.toFixed(3) : '-';
          tabla += `<td class="${clase}">${valor}</td>`;
        }
        tabla += '</tr>';
      }
      tabla += '</tbody></table>';
      document.getElementById('tablaVmVsm').innerHTML = tabla;
    }

    // === MAPA DE CALOR ===
    function renderizarMapaCalor(data) {
      const tuberias = [...new Set(data.map(d => d.tuberia))];
      const concentraciones = [...new Set(data.map(d => d.ss))].sort((a, b) => a - b);

      const colorScale = val => {
        if (val == null) return '#ccc';
        if (val < 1) return 'rgb(255, 100, 100)';
        const hue = Math.min(120, 60 + (val - 1) * 100); // verde si >1
        return `hsl(${hue}, 80%, 60%)`;
      };

      const chartData = [];
      for (let i = 0; i < tuberias.length; i++) {
        for (let j = 0; j < concentraciones.length; j++) {
          const tub = tuberias[i];
          const ss = concentraciones[j];
          const punto = data.find(d => d.tuberia === tub && d.ss === ss);
          if (!punto) continue;
          chartData.push({
            x: ss,
            y: tub,
            v: punto.vmvsm,
            backgroundColor: colorScale(punto.vmvsm)
          });
        }
      }

      const ctx = document.getElementById('heatmapChart').getContext('2d');
      new Chart(ctx, {
        type: 'matrix',
        data: {
          datasets: [{
            label: 'Mapa de calor',
            data: chartData,
            backgroundColor: ctx => ctx.raw.backgroundColor,
            width: ({ chart }) => chart.chartArea.width / concentraciones.length - 2,
            height: ({ chart }) => chart.chartArea.height / tuberias.length - 2
          }]
        },
        options: {
          maintainAspectRatio: false,
          plugins: {
            tooltip: {
              callbacks: {
                title: ctx => `Tubería: ${ctx[0].raw.y}, %SS: ${ctx[0].raw.x}`,
                label: ctx => `Vm/Vsm: ${ctx.raw.v.toFixed(3)}`
              }
            },
            legend: { display: false },
            title: {
              display: true,
              text: 'Mapa de calor Vm/Vsm'
            }
          },
          scales: {
            x: {
              type: 'category',
              labels: concentraciones,
              title: { display: true, text: "%SS" }
            },
            y: {
              type: 'category',
              labels: tuberias,
              title: { display: true, text: "Tubería" }
            }
          }
        }
      });
    }

    // === EJECUCIÓN ===
    renderizarLineas(data);
    renderizarTabla(data);
    renderizarMapaCalor(data);
  </script>
</body>
</html>

