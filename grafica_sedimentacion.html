<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Visualización de Sedimentación</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@1.3.0/dist/chartjs-chart-matrix.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; text-align: center; }
    canvas { display: block; margin: 20px auto; }
    #lineChart, #heatmapCanvas { width: 1000px !important; height: 500px !important; }
    table, th, td { border: 1px solid #ccc; border-collapse: collapse; padding: 6px; text-align: center; margin: auto; }
    th { background-color: #f2f2f2; }
    .rojo { background-color: #f8d7da !important; color: #721c24; }
  </style>
</head>
<body>

  <h2>Gráfico de Líneas Múltiples por Tubería</h2>
  <canvas id="lineChart"></canvas>

  <h2>Tabla Interactiva con Colores</h2>
  <div id="tablaSedimentacion"></div>

  <h2>Mapa de Calor de Sedimentación (Vm/Vsm)</h2>
  <canvas id="heatmapCanvas"></canvas>

  <script>
    const resumenDatos = JSON.parse(localStorage.getItem('resumenDatos')) || [];

    if (!resumenDatos.length) {
      document.body.innerHTML = '<h3 style="color:red;">⚠️ Primero genera el resumen desde index.html</h3>';
      throw new Error("No hay datos en localStorage.");
    }

    const tuberias = [...new Set(resumenDatos.map(f => f[0]))];
    const concentraciones = [...new Set(resumenDatos.map(f => parseFloat(f[8])))]
      .filter(v => !isNaN(v))
      .sort((a, b) => a - b);

    // === 1. GRÁFICO DE LÍNEAS MÚLTIPLES ===
    const datasets = tuberias.map((tubo, i) => {
      const color = `hsl(${(i * 360 / tuberias.length)}, 70%, 50%)`;
      return {
        label: tubo,
        data: resumenDatos
          .filter(f => f[0] === tubo && !isNaN(parseFloat(f[5])))
          .map(f => ({ x: parseFloat(f[8]), y: parseFloat(f[5]) })),
        borderColor: color,
        backgroundColor: color,
        tension: 0.2
      };
    });

    new Chart(document.getElementById('lineChart').getContext('2d'), {
      type: 'line',
      data: { datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { title: { display: true, text: '% Sólidos' }, type: 'linear' },
          y: { title: { display: true, text: 'Vm/Vsm' } }
        }
      }
    });

    // === 2. TABLA INTERACTIVA ===
    const tabla = document.createElement('table');
    const cabecera = ['Tubería', ...concentraciones.map(c => `${c}%`)];
    tabla.innerHTML = '<tr>' + cabecera.map(t => `<th>${t}</th>`).join('') + '</tr>';

    tuberias.forEach(tubo => {
      const fila = document.createElement('tr');
      fila.innerHTML = `<td>${tubo}</td>`;
      concentraciones.forEach(c => {
        const filaData = resumenDatos.find(f => f[0] === tubo && parseFloat(f[8]) === c);
        const valor = filaData ? parseFloat(filaData[5]) : '';
        const td = document.createElement('td');
        td.textContent = valor || '-';
        if (valor && valor < 1) td.classList.add('rojo');
        fila.appendChild(td);
      });
      tabla.appendChild(fila);
    });
    document.getElementById('tablaSedimentacion').appendChild(tabla);

    // === 3. MAPA DE CALOR ===
    const heatData = [];
    tuberias.forEach((t, i) => {
      concentraciones.forEach((c, j) => {
        const f = resumenDatos.find(d => d[0] === t && parseFloat(d[8]) === c);
        if (f) {
          const valor = parseFloat(f[5]);
          heatData.push({
            x: c,
            y: t,
            v: valor
          });
        }
      });
    });

    const ctx = document.getElementById('heatmapCanvas').getContext('2d');
    new Chart(ctx, {
      type: 'matrix',
      data: {
        datasets: [{
          label: 'Mapa de calor Vm/Vsm',
          data: heatData,
          backgroundColor(ctx) {
            const value = ctx.dataset.data[ctx.dataIndex].v;
            if (isNaN(value)) return '#eee';
            const hue = Math.max(0, Math.min(120, value * 120)); // rojo a verde
            return `hsl(${hue}, 80%, 50%)`;
          },
          borderWidth: 1,
          width: () => 30,
          height: () => 20
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              title: () => '',
              label: ctx => `Tubería: ${ctx.raw.y}, %SS: ${ctx.raw.x}, Vm/Vsm: ${ctx.raw.v}`
            }
          }
        },
        scales: {
          x: {
            type: 'linear',
            position: 'bottom',
            title: { display: true, text: '% Sólidos' },
            ticks: { stepSize: 5 }
          },
          y: {
            type: 'category',
            labels: tuberias,
            title: { display: true, text: 'Tubería' }
          }
        }
      }
    });
  </script>
</body>
</html>


